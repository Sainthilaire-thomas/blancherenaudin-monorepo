# ============================================================================
# SCRIPT DE V√âRIFICATION COMPL√àTE - Monorepo Blanche Renaudin
# ============================================================================
# Date: 26 octobre 2025
# Description: V√©rifie l'√©tat complet du projet apr√®s corrections
# ============================================================================

$ProjectRoot = "C:\Users\thoma\OneDrive\SONEAR_2025\blancherenaudin-monorepo"
$ErrorCount = 0
$WarningCount = 0

Write-Host "`n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
Write-Host "‚ïë     V√âRIFICATION COMPL√àTE - Monorepo Blanche Renaudin          ‚ïë" -ForegroundColor Cyan
Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`n" -ForegroundColor Cyan

Set-Location $ProjectRoot

# ============================================================================
# 1. V√âRIFICATION EXPORTS PACKAGES/DATABASE
# ============================================================================
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Yellow
Write-Host "1Ô∏è‚É£  V√âRIFICATION EXPORTS packages/database" -ForegroundColor Yellow
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Yellow

$IndexPath = "packages\database\src\index.ts"
$ServerPath = "packages\database\src\server.ts"

Write-Host "`nüìÑ V√©rification de $IndexPath..." -ForegroundColor Cyan

if (Test-Path $IndexPath) {
    $IndexContent = Get-Content $IndexPath -Raw
    
    # V√©rifier que stripe N'EST PAS export√© depuis index.ts
    if ($IndexContent -match "export.*from.*['\`"]\.\/stripe['\`"]") {
        Write-Host "  ‚ùå ERREUR: stripe est export√© depuis index.ts (PUBLIC)" -ForegroundColor Red
        Write-Host "     ‚Üí Cela cause l'erreur 'Missing STRIPE_SECRET_KEY' dans les Client Components" -ForegroundColor Red
        $ErrorCount++
    } else {
        Write-Host "  ‚úÖ OK: stripe n'est PAS export√© depuis index.ts" -ForegroundColor Green
    }
    
    # V√©rifier les exports s√ªrs
    $SafeExports = @(
        "client-browser",
        "client-server", 
        "types",
        "types-helpers"
    )
    
    foreach ($export in $SafeExports) {
        if ($IndexContent -match "export.*from.*['\`"]\./$export['\`"]") {
            Write-Host "  ‚úÖ Export s√ªr trouv√©: $export" -ForegroundColor Green
        } else {
            Write-Host "  ‚ö†Ô∏è  Export manquant: $export" -ForegroundColor Yellow
            $WarningCount++
        }
    }
} else {
    Write-Host "  ‚ùå ERREUR: $IndexPath introuvable" -ForegroundColor Red
    $ErrorCount++
}

Write-Host "`nüìÑ V√©rification de $ServerPath..." -ForegroundColor Cyan

if (Test-Path $ServerPath) {
    $ServerContent = Get-Content $ServerPath -Raw
    
    # V√©rifier que stripe EST export√© depuis server.ts
    if ($ServerContent -match "export.*stripe.*from.*['\`"]\.\/stripe['\`"]") {
        Write-Host "  ‚úÖ OK: stripe est export√© depuis server.ts" -ForegroundColor Green
    } else {
        Write-Host "  ‚ùå ERREUR: stripe n'est PAS export√© depuis server.ts" -ForegroundColor Red
        $ErrorCount++
    }
    
    # V√©rifier les exports serveur
    $ServerExports = @(
        "client-admin",
        "stripe",
        "decrementStockForOrder"
    )
    
    foreach ($export in $ServerExports) {
        if ($ServerContent -match "$export") {
            Write-Host "  ‚úÖ Export serveur trouv√©: $export" -ForegroundColor Green
        } else {
            Write-Host "  ‚ö†Ô∏è  Export serveur manquant: $export" -ForegroundColor Yellow
            $WarningCount++
        }
    }
} else {
    Write-Host "  ‚ùå ERREUR: $ServerPath introuvable" -ForegroundColor Red
    $ErrorCount++
}

# ============================================================================
# 2. V√âRIFICATION IMPORTS STRIPE DANS STOREFRONT
# ============================================================================
Write-Host "`n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Yellow
Write-Host "2Ô∏è‚É£  V√âRIFICATION IMPORTS STRIPE dans apps/storefront" -ForegroundColor Yellow
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Yellow

Write-Host "`nüîç Recherche d'imports incorrects de stripe..." -ForegroundColor Cyan

$BadStripeImports = Get-ChildItem -Recurse -Include "*.ts","*.tsx" -Path "apps\storefront\app" | 
    Select-String "import.*stripe.*from.*['\`"]@repo\/database['\`"]" |
    Where-Object { $_.Line -notmatch "@repo\/database\/server" }

if ($BadStripeImports) {
    Write-Host "  ‚ùå ERREUR: Imports incorrects de stripe trouv√©s:" -ForegroundColor Red
    $BadStripeImports | ForEach-Object {
        Write-Host "     ‚Üí $($_.Path):$($_.LineNumber)" -ForegroundColor Red
        Write-Host "       $($_.Line.Trim())" -ForegroundColor Gray
    }
    $ErrorCount += $BadStripeImports.Count
    
    Write-Host "`n  üí° CORRECTION N√âCESSAIRE:" -ForegroundColor Yellow
    Write-Host "     Remplacer par: import { stripe } from '@repo/database/server'" -ForegroundColor Yellow
} else {
    Write-Host "  ‚úÖ OK: Aucun import incorrect de stripe trouv√©" -ForegroundColor Green
}

# V√©rifier les imports corrects
$GoodStripeImports = Get-ChildItem -Recurse -Include "*.ts","*.tsx" -Path "apps\storefront\app" | 
    Select-String "import.*stripe.*from.*['\`"]@repo\/database\/server['\`"]"

if ($GoodStripeImports) {
    Write-Host "`n  ‚úÖ Imports corrects trouv√©s: $($GoodStripeImports.Count)" -ForegroundColor Green
    $GoodStripeImports | ForEach-Object {
        Write-Host "     ‚Üí $($_.Path | Split-Path -Leaf):$($_.LineNumber)" -ForegroundColor Green
    }
}

# ============================================================================
# 3. V√âRIFICATION SUPABASE ADMIN
# ============================================================================
Write-Host "`n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Yellow
Write-Host "3Ô∏è‚É£  V√âRIFICATION IMPORTS SUPABASE ADMIN" -ForegroundColor Yellow
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Yellow

Write-Host "`nüîç Recherche d'imports incorrects de supabaseAdmin..." -ForegroundColor Cyan

$BadAdminImports = Get-ChildItem -Recurse -Include "*.ts","*.tsx" -Path "apps\storefront\app" | 
    Select-String "import.*supabaseAdmin.*from.*['\`"]@repo\/database['\`"]" |
    Where-Object { $_.Line -notmatch "@repo\/database\/server" }

if ($BadAdminImports) {
    Write-Host "  ‚ùå ERREUR: Imports incorrects de supabaseAdmin trouv√©s:" -ForegroundColor Red
    $BadAdminImports | ForEach-Object {
        Write-Host "     ‚Üí $($_.Path):$($_.LineNumber)" -ForegroundColor Red
    }
    $ErrorCount += $BadAdminImports.Count
} else {
    Write-Host "  ‚úÖ OK: Aucun import incorrect de supabaseAdmin trouv√©" -ForegroundColor Green
}

# ============================================================================
# 4. TYPECHECK
# ============================================================================
Write-Host "`n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Yellow
Write-Host "4Ô∏è‚É£  TYPECHECK TypeScript" -ForegroundColor Yellow
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Yellow

Write-Host "`nüì¶ Typecheck packages/database..." -ForegroundColor Cyan
Set-Location "packages\database"
$TypeCheckDatabase = pnpm exec tsc --noEmit 2>&1
$DatabaseErrors = $TypeCheckDatabase | Select-String "error TS"

if ($DatabaseErrors) {
    Write-Host "  ‚ùå ERREURS TypeScript dans packages/database:" -ForegroundColor Red
    $DatabaseErrors | ForEach-Object {
        Write-Host "     $_" -ForegroundColor Red
    }
    $ErrorCount += $DatabaseErrors.Count
} else {
    Write-Host "  ‚úÖ OK: Aucune erreur TypeScript dans packages/database" -ForegroundColor Green
}

Set-Location $ProjectRoot

Write-Host "`nüì¶ Typecheck apps/storefront..." -ForegroundColor Cyan
Set-Location "apps\storefront"
$TypeCheckStorefront = pnpm exec tsc --noEmit 2>&1
$StorefrontErrors = $TypeCheckStorefront | Select-String "error TS"

if ($StorefrontErrors) {
    Write-Host "  ‚ùå ERREURS TypeScript dans apps/storefront:" -ForegroundColor Red
    $StorefrontErrors | Select-Object -First 10 | ForEach-Object {
        Write-Host "     $_" -ForegroundColor Red
    }
    if ($StorefrontErrors.Count -gt 10) {
        Write-Host "     ... et $($StorefrontErrors.Count - 10) autres erreurs" -ForegroundColor Red
    }
    $ErrorCount += $StorefrontErrors.Count
} else {
    Write-Host "  ‚úÖ OK: Aucune erreur TypeScript dans apps/storefront" -ForegroundColor Green
}

Set-Location $ProjectRoot

# ============================================================================
# 5. VARIABLES D'ENVIRONNEMENT
# ============================================================================
Write-Host "`n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Yellow
Write-Host "5Ô∏è‚É£  V√âRIFICATION VARIABLES D'ENVIRONNEMENT" -ForegroundColor Yellow
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Yellow

$EnvPath = "apps\storefront\.env.local"

Write-Host "`nüìÑ V√©rification de $EnvPath..." -ForegroundColor Cyan

if (Test-Path $EnvPath) {
    $EnvContent = Get-Content $EnvPath -Raw
    
    $RequiredVars = @{
        "NEXT_PUBLIC_SUPABASE_URL" = "Supabase URL publique"
        "NEXT_PUBLIC_SUPABASE_ANON_KEY" = "Supabase cl√© anonyme publique"
        "SUPABASE_SERVICE_ROLE_KEY" = "Supabase cl√© service (admin)"
        "STRIPE_SECRET_KEY" = "Stripe cl√© secr√®te"
        "STRIPE_PUBLISHABLE_KEY" = "Stripe cl√© publique"
        "STRIPE_WEBHOOK_SECRET" = "Stripe webhook secret"
        "RESEND_API_KEY" = "Resend API key"
        "RESEND_FROM_EMAIL" = "Resend email exp√©diteur"
    }
    
    $MissingVars = @()
    
    foreach ($var in $RequiredVars.Keys) {
        if ($EnvContent -match "$var\s*=\s*.+") {
            Write-Host "  ‚úÖ $var d√©finie" -ForegroundColor Green
        } else {
            Write-Host "  ‚ùå $var MANQUANTE - $($RequiredVars[$var])" -ForegroundColor Red
            $MissingVars += $var
            $ErrorCount++
        }
    }
    
    # V√©rifier l'ancienne variable incorrecte
    if ($EnvContent -match "SUPABASE_SERVICE_KEY\s*=") {
        Write-Host "  ‚ö†Ô∏è  WARNING: Ancienne variable SUPABASE_SERVICE_KEY d√©tect√©e" -ForegroundColor Yellow
        Write-Host "     ‚Üí Utiliser SUPABASE_SERVICE_ROLE_KEY √† la place" -ForegroundColor Yellow
        $WarningCount++
    }
    
    if ($MissingVars.Count -gt 0) {
        Write-Host "`n  üí° Variables manquantes √† ajouter:" -ForegroundColor Yellow
        foreach ($var in $MissingVars) {
            Write-Host "     $var=$($RequiredVars[$var])" -ForegroundColor Yellow
        }
    }
} else {
    Write-Host "  ‚ùå ERREUR: $EnvPath introuvable" -ForegroundColor Red
    Write-Host "     Copier .env.example vers .env.local et remplir les valeurs" -ForegroundColor Yellow
    $ErrorCount++
}

# ============================================================================
# 6. STRUCTURE DES FICHIERS
# ============================================================================
Write-Host "`n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Yellow
Write-Host "6Ô∏è‚É£  V√âRIFICATION STRUCTURE DES FICHIERS" -ForegroundColor Yellow
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Yellow

$CriticalFiles = @(
    "packages\database\src\index.ts",
    "packages\database\src\server.ts",
    "packages\database\src\client-browser.ts",
    "packages\database\src\client-server.ts",
    "packages\database\src\client-admin.ts",
    "packages\database\src\stripe.ts",
    "packages\database\src\stock\decrement-stock.ts",
    "apps\storefront\app\api\webhooks\stripe\route.ts",
    "apps\storefront\app\layout.tsx",
    "apps\storefront\app\globals.css",
    "apps\storefront\tailwind.config.ts"
)

Write-Host "`nüîç V√©rification des fichiers critiques..." -ForegroundColor Cyan

foreach ($file in $CriticalFiles) {
    if (Test-Path $file) {
        Write-Host "  ‚úÖ $file" -ForegroundColor Green
    } else {
        Write-Host "  ‚ùå $file MANQUANT" -ForegroundColor Red
        $ErrorCount++
    }
}

# ============================================================================
# 7. BUILD TEST
# ============================================================================
Write-Host "`n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Yellow
Write-Host "7Ô∏è‚É£  TEST DE BUILD" -ForegroundColor Yellow
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Yellow

Write-Host "`nüî® Build de packages/database..." -ForegroundColor Cyan
Set-Location "packages\database"
$BuildDatabase = pnpm run build 2>&1
$BuildDatabaseErrors = $BuildDatabase | Select-String "error"

if ($BuildDatabaseErrors) {
    Write-Host "  ‚ùå ERREURS lors du build de packages/database" -ForegroundColor Red
    $BuildDatabaseErrors | Select-Object -First 5 | ForEach-Object {
        Write-Host "     $_" -ForegroundColor Red
    }
    $ErrorCount++
} else {
    Write-Host "  ‚úÖ Build de packages/database r√©ussi" -ForegroundColor Green
}

Set-Location $ProjectRoot

# ============================================================================
# R√âSUM√â FINAL
# ============================================================================
Write-Host "`n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
Write-Host "‚ïë                      R√âSUM√â DE LA V√âRIFICATION                 ‚ïë" -ForegroundColor Cyan
Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan

Write-Host "`nüìä Statistiques:" -ForegroundColor White
Write-Host "   ‚Ä¢ Erreurs critiques: $ErrorCount" -ForegroundColor $(if ($ErrorCount -eq 0) { "Green" } else { "Red" })
Write-Host "   ‚Ä¢ Avertissements: $WarningCount" -ForegroundColor $(if ($WarningCount -eq 0) { "Green" } else { "Yellow" })

if ($ErrorCount -eq 0 -and $WarningCount -eq 0) {
    Write-Host "`n‚úÖ F√âLICITATIONS! Le projet est correctement configur√©." -ForegroundColor Green
    Write-Host "   Vous pouvez lancer le dev serveur avec:" -ForegroundColor Green
    Write-Host "   cd apps\storefront" -ForegroundColor Cyan
    Write-Host "   pnpm dev" -ForegroundColor Cyan
} elseif ($ErrorCount -eq 0) {
    Write-Host "`n‚ö†Ô∏è  Le projet fonctionne mais a quelques avertissements mineurs." -ForegroundColor Yellow
    Write-Host "   Vous pouvez lancer le dev serveur, mais corrigez les avertissements." -ForegroundColor Yellow
} else {
    Write-Host "`n‚ùå ATTENTION: Des erreurs critiques doivent √™tre corrig√©es." -ForegroundColor Red
    Write-Host "   Consultez les d√©tails ci-dessus pour les r√©soudre." -ForegroundColor Red
}

Write-Host "`n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`n" -ForegroundColor Cyan
