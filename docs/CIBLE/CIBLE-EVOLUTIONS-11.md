# üß≠ ARCHITECTURE CIBLE ‚Äî RECOMMANDATIONS v1.1

### *Plan d‚Äô√©volution et d‚Äôoptimisation continue avant et apr√®s la migration du premier tool (`products`)*

---

## 1. üéØ Objectif du document

Cette page compl√®te la **documentation d‚Äôarchitecture cible** existante.

Elle vise √† :

* S√©curiser la **phase de migration des tools** (ex : `products`)
* Renforcer la **robustesse, la maintenabilit√© et la scalabilit√©** du monorepo
* D√©finir un **plan d‚Äôam√©lioration continue** apr√®s la premi√®re migration

> üìò Cette version est dite ‚Äúv1.1 ‚Äì post-migration‚Äù : elle n‚Äôintroduit pas de refonte, seulement des √©volutions structurantes.

---

## 2. üß± Structure monorepo et conventions

### ‚úÖ Bonnes pratiques valid√©es

* Architecture **apps / packages / tools**
* S√©paration claire entre :
  * `apps/` : shell Next.js (UI globale, routage, s√©curit√©)
  * `packages/tools/` : tools m√©tiers autonomes
  * `packages/ui/`, `packages/database/`, `packages/types/` : partages communs
* Routes ‚Äúminces‚Äù dans l‚Äôapp Next ‚Üí logique pure dans les tools

### üîß Recommandations

| Am√©lioration                           | D√©tail                                                                                                                                | Impact                                                  |
| --------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------- |
| **Automatiser le ToolRegistry**   | Script Node `generate-tool-registry.ts`qui parcourt `packages/tools/*/manifest.ts`et g√©n√®re `apps/admin/lib/tool-registry.ts`. | Supprime les oublis manuels et maintient la coh√©rence. |
| **Alias TS `@tools/*`**         | Ajouter dans `tsconfig.base.json`:`"@tools/*": ["packages/tools/*/src"]`                                                           | Lisibilit√© accrue dans les imports et DX am√©lior√©e.  |
| **Convention de nommage stricte** | Tous les packages tools ‚Üí`@repo/tools-<name>`                                                                                       | Facilite la g√©n√©ration automatique et la CI.          |

---

## 3. üß≠ Routage, Loader et RBAC

### ‚úÖ Bonnes pratiques valid√©es

* App Router ‚Üí `(tools)/<tool>/` avec pages minces
* `ToolLoader` dynamique avec RBAC client-side
* V√©rification d‚Äôacc√®s avant lazy-load

### üîß Recommandations

| Am√©lioration                            | D√©tail                                                                                                                                                                         | Impact                                                           |
| ---------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- |
| **Guard serveur RSC**              | Ajouter une v√©rification c√¥t√© serveur avant rendu du layout du tool :                                                                                                        | S√©curit√© renforc√©e, emp√™che le pr√©chargement non autoris√©. |
|                                          | `tsximport { requirePermission } from '@/lib/rbac';export default async function Layout({ children }) {  await requirePermission('products:read');  return <>{children}</>;}` |                                                                  |
| **ErrorBoundary global par tool**  | Wrapper syst√©matique autour du `ToolLoader`(affiche un fallback clair + capture Sentry).                                                                                     | Am√©liore r√©silience et observabilit√©.                         |
| **Loader asynchrone instrument√©** | Log du temps de chargement et des erreurs par tool.                                                                                                                             | Permet des m√©triques de performance par module.                 |

---

## 4. üß© UI et Design System (`@repo/ui`)

### ‚úÖ Bonnes pratiques valid√©es

* Design System MUI partag√©, compatible RSC
* Th√®me et tokens centralis√©s

### üîß Recommandations

| Am√©lioration                            | D√©tail                                                                                                     | Impact                                       |
| ---------------------------------------- | ----------------------------------------------------------------------------------------------------------- | -------------------------------------------- |
| **Audit d‚Äôaccessibilit√© (a11y)** | Lancer `axe-core`en CI sur chaque preview.                                                                | Am√©liore la conformit√© AA/AAA.             |
| **Exports clients explicites**     | Marquer les composants non-RSC (`use client`) dans `@repo/ui`avec suffixe `.client.tsx`.              | R√©duit les warnings et erreurs Next.js.     |
| **Catalogue interne**              | Ajouter `/docs/ui-components`(Storybook ou sandbox Next) pour visualiser les composants du design system. | Favorise la coh√©rence visuelle entre tools. |

---

## 5. üîí S√©curit√© et gestion des acc√®s

### ‚úÖ Bonnes pratiques valid√©es

* RBAC via `ToolRegistry.permissions`
* Middleware Next.js + policies Supabase (RLS)

### üîß Recommandations

| Am√©lioration                         | D√©tail                                                                                  | Impact                                     |
| ------------------------------------- | ---------------------------------------------------------------------------------------- | ------------------------------------------ |
| **RLS syst√©matique**           | Script SQL d‚Äôaudit automatis√© v√©rifiant la pr√©sence de RLS sur chaque table.         | Garantit la conformit√© s√©curit√©.        |
| **`ServerGuard`standardis√©** | Factory de guards `requirePermission('scope')`‚Üí utilis√©e par tous les layouts tools. | Uniformit√© et moins d‚Äôerreurs manuelles. |
| **Logs d‚Äôacc√®s**              | Enregistrer les acc√®s tools (org_id, user_id, route) dans `logs_access`.              | Audit trail et observabilit√© s√©curit√©.  |

---

## 6. üßÆ Donn√©es, Supabase et Data Layer

### ‚úÖ Bonnes pratiques valid√©es

* Clients `browser`, `server`, `admin` distincts
* Typage auto via `supabase gen types`
* Logique pure et testable dans `packages/tools/*/api`

### üîß Recommandations

| Am√©lioration                             | D√©tail                                                                                      | Impact                                                |
| ----------------------------------------- | -------------------------------------------------------------------------------------------- | ----------------------------------------------------- |
| **Cr√©er un ‚ÄúData Layer‚Äù commun** | Dossier `packages/database/src/repositories/`: fonctions r√©utilisables multi-tools.       | R√©duit duplication et divergence des requ√™tes.      |
| **Validation syst√©matique Zod**    | Chaque API handler utilise un sch√©ma `inputSchema.safeParse()`.                           | Typage runtime + pr√©vention des erreurs utilisateur. |
| **Abstraction RPC**                 | Fonctions `callRpc('function', params)`pour √©viter les appels SQL directs dans les tools. | Simplifie la maintenance et la s√©curit√©.            |

---

## 7. ‚öôÔ∏è Tests et qualit√©

### ‚úÖ Bonnes pratiques valid√©es

* Unit tests sur les API ‚Äúpures‚Äù
* Tests E2E de base via Playwright

### üîß Recommandations

| Am√©lioration                              | D√©tail                                             | Impact                                            |
| ------------------------------------------ | --------------------------------------------------- | ------------------------------------------------- |
| **Tests d‚Äôint√©gration API routes** | Mock Supabase et v√©rifier les statuts 200/403/500. | Couverture du pipeline RBAC compl√®te.            |
| **Rapport de couverture (Codecov)**  | Int√©grer dans la CI ‚Üí badge de couverture global. | Mesure continue de la qualit√©.                   |
| **Snapshots UI**                     | Int√©grer Storybook +`chromatic`ou `happo.io`.  | D√©tection automatique de r√©gressions visuelles. |

---

## 8. üß± Performance et observabilit√©

### ‚úÖ Bonnes pratiques valid√©es

* `optimizePackageImports`
* Budgets de bundles
* Turborepo cache et CI optimis√©e

### üîß Recommandations

| Am√©lioration                                | D√©tail                                                                         | Impact                                   |
| -------------------------------------------- | ------------------------------------------------------------------------------- | ---------------------------------------- |
| **Sentry global**                      | Brancher Sentry au niveau du `ErrorBoundary`du ToolLoader.                    | Tra√ßabilit√© des erreurs runtime.       |
| **Dashboard interne ‚ÄúTools Status‚Äù** | Afficher par tool : version, taille bundle, temps de load, erreurs.             | Monitoring interne clair pour le DevOps. |
| **Compression et image CDN**           | Configurer les headers `NextResponse`+ images optimis√©es via `next/image`. | R√©duction du TTFB et du LCP.            |

---

## 9. üß∞ CI/CD et DevOps

### ‚úÖ Bonnes pratiques valid√©es

* Workflow complet (typecheck, lint, build, test)
* Turbo pipelines
* Preview automatique sur PR

### üîß Recommandations

| Am√©lioration                             | D√©tail                                                              | Impact                                    |
| ----------------------------------------- | -------------------------------------------------------------------- | ----------------------------------------- |
| **Job ‚ÄúGenerate Supabase Types‚Äù** | V√©rifie les diffs sur les types DB avant merge.                     | D√©tecte les breaking changes DB.         |
| **Analyse de bundle automatis√©e**  | Int√©grer `next-bundle-analyzer`en job CI avec seuils max.         | Suivi des performances sur le long terme. |
| **Preview E2E**                     | Lancer un test Playwright sur la preview Vercel apr√®s d√©ploiement. | Assurance qualit√© avant merge.           |

---

## 10. üìà Scalabilit√© √† moyen terme

| Th√®me                              | Recommandation                                                                                                                   | Objectif                                              |
| ----------------------------------- | -------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------- |
| **Communication inter-tools** | Impl√©menter un `ShellEventBus`(pub/sub React Context) pour propager des √©v√©nements (`product.updated`,`order.refresh`). | Synchronisation inter-tools sans d√©pendance directe. |
| **Versioning des tools**      | Ajouter un champ `version`dans chaque manifest + registry.                                                                     | Compatibilit√© ascendante et audit.                   |
| **Docs API automatiques**     | G√©n√©ration Markdown/OpenAPI √† partir des fonctions dans `packages/tools/*/api`.                                             | Documentation vivante des endpoints.                  |
| **Feature Flags**             | Table `features`Supabase + hook `useFeatureFlag('tool_x')`.                                                                  | Activer/d√©sactiver des tools dynamiquement.          |

---

## 11. üß† Synth√®se

| Domaine          | √âtat actuel | Prochaine √©tape                             |
| ---------------- | ------------ | -------------------------------------------- |
| Monorepo & Build | ‚úÖ Stable    | Automatiser le registry & alias TS           |
| Routage & Loader | ‚úÖ Fiable    | Ajouter guard serveur & instrumentation      |
| Data Layer       | ‚úÖ Solide    | Introduire `repositories/`& validation Zod |
| S√©curit√©       | ‚úÖ Compl√®te | Audit RLS & logs d‚Äôacc√®s                   |
| Tests            | üü° Partiel   | √âtendre √† int√©gration & couverture        |
| CI/CD            | üü¢ Avanc√©   | Reporting bundle & g√©n√©ration types        |
| Observabilit√©   | ‚ö™ Optionnel | Sentry + dashboard ‚ÄúTools Status‚Äù          |

---

## 12. üß© Conclusion

L‚Äôarchitecture cible actuelle est **tr√®s bien con√ßue** ‚Äî claire, modulaire et align√©e sur les standards modernes de Next.js 15 / Turborepo / Supabase.

Les recommandations ci-dessus visent uniquement √† :

* **Renforcer la robustesse** (guard serveur, RLS audit√©)
* **Am√©liorer la maintenabilit√©** (registry auto, data layer partag√©)
* **Optimiser la qualit√© et la visibilit√©** (tests, Sentry, dashboards)

> üöÄ Une fois ces ajustements appliqu√©s, ton architecture atteindra le niveau d‚Äôun  **design ‚Äúenterprise-ready‚Äù** , pr√™t √† accueillir des dizaines de tools ind√©pendants avec un cycle CI/CD ma√Ætris√©.
>
